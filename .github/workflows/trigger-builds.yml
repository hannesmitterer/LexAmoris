name: Trigger Dependent Builds

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      target-repos:
        description: 'Comma-separated list of repositories to trigger (owner/repo format)'
        required: false
        default: 'hannesmitterer/nexus,hannesmitterer/Resonance-,hannesmitterer/euystacio-helmi-ai'
        type: string
      workflow-name:
        description: 'Workflow filename to trigger (e.g., ci.yml)'
        required: false
        default: 'ci.yml'
        type: string

jobs:
  trigger-builds:
    name: Trigger Builds in Dependent Repositories
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get commit info
        id: commit
        run: |
          echo "sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "message=$(git log -1 --pretty=%B | head -n1)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

      - name: Dispatch builds to dependent repositories
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_REPOS: ${{ inputs.target-repos || 'hannesmitterer/nexus,hannesmitterer/Resonance-,hannesmitterer/euystacio-helmi-ai' }}
          WORKFLOW_NAME: ${{ inputs.workflow-name || 'ci.yml' }}
        run: |
          IFS=',' read -ra REPOS <<< "$TARGET_REPOS"
          
          for repo in "${REPOS[@]}"; do
            echo "Triggering build in: $repo"
            
            # Send repository_dispatch event
            response=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${repo}/dispatches" \
              -d "{
                \"event_type\": \"lexamoris-update\",
                \"client_payload\": {
                  \"source_repo\": \"${GITHUB_REPOSITORY}\",
                  \"source_sha\": \"${GITHUB_SHA}\",
                  \"source_ref\": \"${GITHUB_REF}\",
                  \"commit_message\": \"${{ steps.commit.outputs.message }}\",
                  \"commit_author\": \"${{ steps.commit.outputs.author }}\",
                  \"triggered_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                }
              }")
            
            http_code=$(echo "$response" | tail -n1)
            
            if [ "$http_code" = "204" ]; then
              echo "✅ Successfully triggered repository_dispatch in $repo"
            else
              echo "⚠️  Warning: Failed to trigger $repo (HTTP $http_code)"
            fi
          done

      - name: Trigger workflow runs (alternative method)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_REPOS: ${{ inputs.target-repos || 'hannesmitterer/nexus,hannesmitterer/Resonance-,hannesmitterer/euystacio-helmi-ai' }}
          WORKFLOW_NAME: ${{ inputs.workflow-name || 'ci.yml' }}
        run: |
          IFS=',' read -ra REPOS <<< "$TARGET_REPOS"
          
          for repo in "${REPOS[@]}"; do
            echo "Attempting to trigger workflow in: $repo"
            
            # Try to trigger workflow_dispatch if workflow exists
            response=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${repo}/actions/workflows/${WORKFLOW_NAME}/dispatches" \
              -d "{
                \"ref\": \"main\",
                \"inputs\": {
                  \"triggered_by\": \"LexAmoris update\",
                  \"source_sha\": \"${GITHUB_SHA:0:7}\"
                }
              }" 2>/dev/null)
            
            http_code=$(echo "$response" | tail -n1)
            
            if [ "$http_code" = "204" ]; then
              echo "✅ Successfully triggered workflow in $repo"
            else
              echo "ℹ️  Workflow trigger not available for $repo (may need repository_dispatch event)"
            fi
          done

      - name: Summary
        run: |
          echo "## Build Trigger Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Triggered builds in dependent repositories from LexAmoris update:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Source commit: \`${{ steps.commit.outputs.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Commit message: ${{ steps.commit.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo "- Target repositories: \`${TARGET_REPOS}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Dependent repositories should now rebuild/redeploy with the latest LexAmoris changes." >> $GITHUB_STEP_SUMMARY
