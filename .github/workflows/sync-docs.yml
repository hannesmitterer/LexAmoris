name: Sync Documentation

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'README_PARTNERS.md'
      - 'mission.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      target-repos:
        description: 'Comma-separated list of target repositories (owner/repo format)'
        required: false
        default: 'hannesmitterer/nexus,hannesmitterer/Resonance-,hannesmitterer/euystacio-helmi-ai'
        type: string
      sync-files:
        description: 'Comma-separated list of files to sync'
        required: false
        default: 'README_PARTNERS.md,mission.md'
        type: string

jobs:
  sync-documentation:
    name: Sync Documentation to Related Repositories
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout LexAmoris repository
        uses: actions/checkout@v4
        with:
          path: source

      - name: Setup Git
        run: |
          git config --global user.name "LexAmoris Sync Bot"
          git config --global user.email "actions@github.com"

      - name: Sync to target repositories
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_REPOS: ${{ inputs.target-repos || 'hannesmitterer/nexus,hannesmitterer/Resonance-,hannesmitterer/euystacio-helmi-ai' }}
          SYNC_FILES: ${{ inputs.sync-files || 'README_PARTNERS.md,mission.md' }}
        run: |
          IFS=',' read -ra REPOS <<< "$TARGET_REPOS"
          IFS=',' read -ra FILES <<< "$SYNC_FILES"
          
          for repo in "${REPOS[@]}"; do
            echo "Processing repository: $repo"
            repo_name=$(echo "$repo" | cut -d'/' -f2)
            
            # Clone target repository
            if ! git clone "https://x-access-token:${GITHUB_TOKEN}@github.com/${repo}.git" "target/${repo_name}" 2>/dev/null; then
              echo "⚠️  Warning: Could not clone ${repo}. Skipping..."
              continue
            fi
            
            cd "target/${repo_name}"
            
            # Create sync branch
            branch_name="sync/docs-from-lexamoris-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$branch_name"
            
            # Copy files
            files_updated=false
            for file in "${FILES[@]}"; do
              if [ -f "../../source/$file" ]; then
                echo "Syncing $file to $repo"
                mkdir -p "$(dirname "$file")"
                cp "../../source/$file" "$file"
                git add "$file"
                files_updated=true
              else
                echo "⚠️  Warning: Source file $file not found. Skipping..."
              fi
            done
            
            # Commit and push if there are changes
            if [ "$files_updated" = true ] && ! git diff --cached --quiet; then
              git commit -m "docs: sync documentation from LexAmoris

              Auto-synced files: ${SYNC_FILES}
              Source: hannesmitterer/LexAmoris@${GITHUB_SHA:0:7}
              
              This update is part of the LexAmoris ecosystem synchronization.
              "
              
              if git push origin "$branch_name" 2>/dev/null; then
                echo "✅ Successfully pushed changes to $repo"
                
                # Create PR using GitHub API
                pr_response=$(curl -s -X POST \
                  -H "Accept: application/vnd.github+json" \
                  -H "Authorization: Bearer ${GITHUB_TOKEN}" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  "https://api.github.com/repos/${repo}/pulls" \
                  -d "{
                    \"title\": \"docs: sync documentation from LexAmoris\",
                    \"body\": \"Auto-sync of documentation from LexAmoris repository.\n\nUpdated files:\n$(echo "$SYNC_FILES" | tr ',' '\n' | sed 's/^/- /')\n\nSource commit: hannesmitterer/LexAmoris@${GITHUB_SHA:0:7}\",
                    \"head\": \"$branch_name\",
                    \"base\": \"main\"
                  }" 2>&1)
                
                if echo "$pr_response" | grep -q '"number"'; then
                  echo "✅ Pull request created successfully"
                else
                  echo "ℹ️  Note: PR creation response: $pr_response"
                fi
              else
                echo "⚠️  Warning: Could not push to ${repo}. Check repository permissions."
              fi
            else
              echo "ℹ️  No changes to sync for $repo"
            fi
            
            cd ../..
          done

      - name: Cleanup
        if: always()
        run: |
          rm -rf target/
