name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint-python:
    name: Python Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  lint-javascript:
    name: JavaScript Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          if [ -f package.json ]; then npm install; fi
      
      - name: Lint with eslint
        run: |
          if [ -f package.json ]; then npm run lint || echo "No lint script found, skipping"; else echo "No package.json found, skipping JS linting"; fi

  test-python:
    name: Python Unit Tests
    runs-on: ubuntu-latest
    needs: lint-python
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run tests
        run: |
          if [ -d tests ] || [ -d test ]; then
            pytest --cov=. --cov-report=xml --cov-report=term
          else
            echo "No test directory found, skipping tests"
          fi

  test-javascript:
    name: JavaScript Unit Tests
    runs-on: ubuntu-latest
    needs: lint-javascript
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          if [ -f package.json ]; then npm install; else echo "No package.json found"; fi
      
      - name: Run tests
        run: |
          if [ -f package.json ]; then npm test || echo "No test script found"; else echo "No package.json found, skipping JS tests"; fi

  docker-build:
    name: Docker Integration Testing
    runs-on: ubuntu-latest
    needs: [test-python, test-javascript]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          if [ -f Dockerfile ]; then
            docker build -t lexamoris:test .
          else
            echo "No Dockerfile found, skipping Docker build"
          fi
      
      - name: Test Docker container
        run: |
          if [ -f Dockerfile ]; then
            docker run --rm lexamoris:test echo "Docker container test successful"
          else
            echo "No Dockerfile found, skipping Docker tests"
          fi
